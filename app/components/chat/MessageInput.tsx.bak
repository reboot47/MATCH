"use client";

import { useState, useRef, ChangeEvent, KeyboardEvent } from 'react';
import { HiPaperClip, HiPhotograph, HiLocationMarker, HiVideoCamera, HiEmojiHappy } from 'react-icons/hi';
import { RiSendPlaneFill } from 'react-icons/ri';
import { IoClose } from 'react-icons/io5';
import { MdWarning } from 'react-icons/md';
import Image from 'next/image';
import { motion, AnimatePresence } from 'framer-motion';
import { ImageAttachment, VideoAttachment, LocationAttachment, UrlAttachment } from '@/app/types/chat';
import toast from 'react-hot-toast';

interface MessageInputProps {
  onSendMessage: (text: string, attachments: any[]) => void;
  onTypingStart?: () => void;
  onTypingEnd?: () => void;
  disabled?: boolean;
  placeholder?: string;
  gender?: 'male' | 'female';
  currentPoints?: number;
  requiredPoints?: number;
  onPointsUpdated?: (points: number) => void;
}

export default function MessageInput({
  onSendMessage,
  onTypingStart,
  onTypingEnd,
  disabled = false,
  placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...',
  gender = 'male',
  currentPoints = 0,
  requiredPoints = 5,
  onPointsUpdated
}: MessageInputProps) {
  const [text, setText] = useState('');
  const [attachments, setAttachments] = useState<any[]>([]);
  const [isAttachmentMenuOpen, setIsAttachmentMenuOpen] = useState(false);
  const [isEmoticonPickerOpen, setIsEmoticonPickerOpen] = useState(false);
  const [sending, setSending] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const videoInputRef = useRef<HTMLInputElement>(null);

  // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleTextChange = (e: ChangeEvent<HTMLTextAreaElement>) => {
    setText(e.target.value);
    
    // å…¥åŠ›ä¸­ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
    if (e.target.value && !text) {
      onTypingStart?.();
    } else if (!e.target.value && text) {
      onTypingEnd?.();
    }
  };

  // Enterã‚­ãƒ¼ã§ã®é€ä¿¡
  const handleKeyDown = (e: KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  // ç”»åƒæ·»ä»˜ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleImageAttachment = (e: ChangeEvent<HTMLInputElement>) => {
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è‡ªå‹•çš„ã«é–‰ã˜ã‚‹
    setIsAttachmentMenuOpen(false);
    
    if (e.target.files && e.target.files.length > 0) {
      // æ—¢å­˜ã®ç”»åƒæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’å–å¾—
      const existingImageCount = attachments.filter(a => a.type === 'image').length;
      
      // æœ€å¤§5æšã¾ã§ã®åˆ¶é™ï¼ˆLINEä»•æ§˜ã«æº–æ‹ ï¼‰
      const maxAdditionalImages = 5 - existingImageCount;
      
      if (maxAdditionalImages <= 0) {
        toast.error('ç”»åƒã¯æœ€å¤§5æšã¾ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™');
        if (fileInputRef.current) fileInputRef.current.value = '';
        return;
      }
      
      // è¿½åŠ ã§ãã‚‹ç”»åƒæ•°ã«åˆ¶é™
      const filesToAdd = Array.from(e.target.files).slice(0, maxAdditionalImages);
      
      const newAttachments = filesToAdd.map(file => {
        const url = URL.createObjectURL(file);
        const attachment: ImageAttachment = {
          id: Math.random().toString(36).substr(2, 9),
          type: 'image',
          url,
          createdAt: new Date()
        };
        return attachment;
      });
      
      setAttachments([...attachments, ...newAttachments]);
      if (fileInputRef.current) fileInputRef.current.value = '';
      
      // åˆ¶é™ã«é”ã—ãŸå ´åˆã¯é€šçŸ¥
      if (existingImageCount + filesToAdd.length >= 5) {
        toast.success('ç”»åƒã®æœ€å¤§æ•°ï¼ˆ5æšï¼‰ã«é”ã—ã¾ã—ãŸ', {
          icon: 'ğŸ“·',
          style: {
            background: '#4B5563',
            color: '#FFFFFF'
          }
        });
      }
    }
  };

  // å‹•ç”»æ·»ä»˜ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleVideoAttachment = (e: ChangeEvent<HTMLInputElement>) => {
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è‡ªå‹•çš„ã«é–‰ã˜ã‚‹
    setIsAttachmentMenuOpen(false);
    
    if (e.target.files && e.target.files.length > 0) {
      // LINEã§ã¯å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€åº¦ã«1ã¤ã®ã¿é€ä¿¡å¯èƒ½
      // æ—¢å­˜ã®å‹•ç”»ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼é€šçŸ¥
      if (attachments.some(a => a.type === 'video')) {
        toast.error('å‹•ç”»ã¯ä¸€åº¦ã«1ã¤ã¾ã§æ·»ä»˜ã§ãã¾ã™');
        if (videoInputRef.current) videoInputRef.current.value = '';
        return;
      }
      
      const file = e.target.files[0];
      const url = URL.createObjectURL(file);
      
      // å‹•ç”»ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹
      // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆç”¨ã«ä»®ã®å‹•ç”»è¦ç´ ã‚’ä½œæˆ
      const video = document.createElement('video');
      video.preload = 'metadata';
      video.src = url;
      
      // ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†æ™‚ã«å®Ÿè¡Œ
      video.onloadedmetadata = () => {
        // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆç”¨ã®ä»®ã‚­ãƒ£ãƒ³ãƒã‚¹
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // å‹•ç”»ã®ä¸­é–“ä»˜è¿‘ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚µãƒ ãƒã‚¤ãƒ«ã¨ã—ã¦ä½¿ç”¨
        video.currentTime = Math.min(1, video.duration / 2);
      };
      
      video.onseeked = () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        const ctx = canvas.getContext('2d');
        if (ctx) {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          // ç”»åƒã‚’URLåŒ–
          try {
            const thumbnailUrl = canvas.toDataURL('image/jpeg');
            
            const attachment: VideoAttachment = {
              id: Math.random().toString(36).substr(2, 9),
              type: 'video',
              url,
              thumbnailUrl,
              duration: video.duration,
              createdAt: new Date()
            };
            
            setAttachments([...attachments, attachment]);
            toast.success('å‹•ç”»ã‚’æ·»ä»˜ã—ã¾ã—ãŸ');
          } catch (e) {
            // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆå¤±æ•—æ™‚ã¯ã‚µãƒ ãƒã‚¤ãƒ«ãªã—ã§æ·»ä»˜
            const attachment: VideoAttachment = {
              id: Math.random().toString(36).substr(2, 9),
              type: 'video',
              url,
              createdAt: new Date()
            };
            
            setAttachments([...attachments, attachment]);
            toast.success('å‹•ç”»ã‚’æ·»ä»˜ã—ã¾ã—ãŸ');
          }
        }
      };
      
      // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯ã‚µãƒ ãƒã‚¤ãƒ«ãªã—ã§æ·»ä»˜
      video.onerror = () => {
        const attachment: VideoAttachment = {
          id: Math.random().toString(36).substr(2, 9),
          type: 'video',
          url,
          createdAt: new Date()
        };
        
        setAttachments([...attachments, attachment]);
        toast.success('å‹•ç”»ã‚’æ·»ä»˜ã—ã¾ã—ãŸ');
      };
      
      if (videoInputRef.current) videoInputRef.current.value = '';
    }
  };

  // ä½ç½®æƒ…å ±æ·»ä»˜ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleLocationAttachment = () => {
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è‡ªå‹•çš„ã«é–‰ã˜ã‚‹
    setIsAttachmentMenuOpen(false);
    
    // ä½ç½®æƒ…å ±å–å¾—ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    toast.loading('ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...', { id: 'location-toast' });
    
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          try {
            // ç·¯åº¦çµŒåº¦ã‹ã‚‰ä½æ‰€æƒ…å ±ã‚’å–å¾—ã™ã‚‹
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°APIã‚’ä½¿ç”¨ã—ã¦ä½æ‰€ã‚’å–å¾—
            // å®Ÿé¨“ç”¨ã«ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™é–¢æ•°ã‚’ä½¿ç”¨
            const address = await getAddressFromCoordinates(lat, lng);
            
            // åœ°å›³ã®é™çš„ç”»åƒã‚’ç”Ÿæˆ
            const mapPreviewUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=15&size=600x300&markers=color:red%7C${lat},${lng}&key=YOUR_API_KEY`;
            
            // ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨ã®åœ°å›³URL
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
            
            const locationAttachment: LocationAttachment = {
              id: Math.random().toString(36).substr(2, 9),
              type: 'location',
              latitude: lat,
              longitude: lng,
              name: 'ç¾åœ¨åœ°',
              address: address,
              url: mapsUrl,
              previewUrl: mapPreviewUrl,
              createdAt: new Date()
            };
            
            setAttachments([...attachments, locationAttachment]);
            toast.dismiss('location-toast');
            toast.success('ä½ç½®æƒ…å ±ã‚’æ·»ä»˜ã—ã¾ã—ãŸ');
          } catch (error) {
            console.error('ä½ç½®æƒ…å ±ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
            toast.dismiss('location-toast');
            toast.error('ä½ç½®æƒ…å ±ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        },
        (error) => {
          console.error('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
          toast.dismiss('location-toast');
          toast.error('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã®è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    } else {
      toast.dismiss('location-toast');
      toast.error('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
    }
  };
  
  // åº§æ¨™ã‹ã‚‰ä½æ‰€ã‚’å–å¾—ã™ã‚‹é–¢æ•° (å®Ÿé¨“ç”¨ã«ç°¡ç•¥åŒ–)
  const getAddressFromCoordinates = async (latitude: number, longitude: number): Promise<string> => {
    // å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ã€ã“ã“ã§Google Maps Geocoding APIãªã©ã‚’å‘¼ã³å‡ºã™
    // ãƒ‡ãƒ¢ç”¨ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
    return 'æ±äº¬éƒ½æ¸‹è°·åŒºæ¸‹è°·1-2-3';
  };

  // URLæ¤œå‡º
  const detectUrlsInText = (text: string): UrlAttachment[] => {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    const matches = text.match(urlRegex);
    
    if (!matches) return [];
    
    return matches.map(url => ({
      id: Math.random().toString(36).substr(2, 9),
      type: 'url',
      url,
      createdAt: new Date(),
    }));
  };

  // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
  const removeAttachment = (id: string) => {
    setAttachments(attachments.filter(a => a.id !== id));
  };

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  const handleSendMessage = () => {
    console.log('é€ä¿¡ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
    console.log('ãƒ†ã‚­ã‚¹ãƒˆ:', text);
    console.log('æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«:', attachments);
    
    // ãƒ‡ã‚£ã‚»ãƒ¼ãƒ–ãƒ«ç¢ºèª
    if ((!text && attachments.length === 0) || disabled) {
      console.log('é€ä¿¡æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“:', {
        text: text.length > 0,
        attachments: attachments.length > 0,
        disabled: disabled
      });
      return;
    }
    
    // ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰URLæ¤œå‡º
    const urlAttachments = detectUrlsInText(text);
    const allAttachments = [...attachments];
    
    // URLãŒæ—¢ã«æ·»ä»˜ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿è¿½åŠ 
    for (const urlAttachment of urlAttachments) {
      if (!allAttachments.some(a => a.type === 'url' && a.url === urlAttachment.url)) {
        allAttachments.push(urlAttachment);
      }
    }
    
    console.log('å…¨æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«:', allAttachments);
    
    // ç”·æ€§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ãƒã‚¤ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
    if (gender === 'male') {
      // å†™çœŸã‚„å‹•ç”»ã®æ·»ä»˜ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ ãƒã‚¤ãƒ³ãƒˆãŒå¿…è¦
      const mediaAttachmentCount = allAttachments.filter(
        att => att.type === 'image' || att.type === 'video'
      ).length;
      
      const totalRequiredPoints = requiredPoints + (mediaAttachmentCount * 3); // ãƒ¡ãƒ‡ã‚£ã‚¢ã”ã¨ã«è¿½åŠ 3ãƒã‚¤ãƒ³ãƒˆ
      
      if (currentPoints < totalRequiredPoints) {
        toast.error(`ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚${totalRequiredPoints}ãƒã‚¤ãƒ³ãƒˆå¿…è¦ã§ã™ã€‚`);
        return;
      }
      
      // ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»
      if (onPointsUpdated) {
        onPointsUpdated(currentPoints - totalRequiredPoints);
        toast.success(`${totalRequiredPoints}ãƒã‚¤ãƒ³ãƒˆã‚’æ¶ˆè²»ã—ã¾ã—ãŸã€‚`);
      }
    } else if (gender === 'female' && onPointsUpdated) {
      // å¥³æ€§ã®å ´åˆã€ãƒã‚¤ãƒ³ãƒˆç²å¾—
      const earnedPoints = requiredPoints;
      onPointsUpdated(currentPoints + earnedPoints);
      toast.success(`${earnedPoints}ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã—ãŸï¼`, {
        icon: 'ğŸ',
        style: {
          background: '#10B981',
          color: '#FFFFFF'
        }
      });
    }
    
    setSending(true);
    
    try {
      console.log('é€ä¿¡é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™', onSendMessage);
      onSendMessage(text, allAttachments);
      console.log('é€ä¿¡é–¢æ•°ã®å‘¼ã³å‡ºã—ãŒæˆåŠŸã—ã¾ã—ãŸ');
    } catch (error) {
      console.error('é€ä¿¡é–¢æ•°ã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      toast.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    setText('');
    setAttachments([]);
    onTypingEnd?.();
    
    setTimeout(() => {
      setSending(false);
      console.log('é€ä¿¡å®Œäº†');
    }, 1000);
  };

  // å†™çœŸãƒ»å‹•ç”»æ·»ä»˜æ™‚ã®è¿½åŠ ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
  const calculateAdditionalPointsForMedia = () => {
    if (gender !== 'male') return 0;
    
    const mediaCount = attachments.filter(att => att.type === 'image' || att.type === 'video').length;
    return mediaCount * 3; // ãƒ¡ãƒ‡ã‚£ã‚¢æ·»ä»˜1ã¤ã«ã¤ã3ãƒã‚¤ãƒ³ãƒˆ
  };

  // é€ä¿¡ã«å¿…è¦ãªåˆè¨ˆãƒã‚¤ãƒ³ãƒˆ
  const totalPointsRequired = gender === 'male' ? requiredPoints + calculateAdditionalPointsForMedia() : 0;
  
  // ãƒã‚¤ãƒ³ãƒˆä¸è¶³ã‹ã©ã†ã‹
  const isPointsInsufficient = gender === 'male' && totalPointsRequired > currentPoints;

  return (
    <div className="border-t border-gray-200 bg-white p-3">
      {/* æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
      {attachments.length > 0 && (
        <div className="flex flex-wrap gap-2 mb-2">
          {/* ç”»åƒãŒè¤‡æ•°ã‚ã‚‹å ´åˆã®ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ */}
          {attachments.filter(a => a.type === 'image').length > 1 && (
            <button
              onClick={() => setAttachments(attachments.filter(a => a.type !== 'image'))}
              className="text-xs text-red-500 hover:text-red-700 ml-1 mb-2 flex items-center bg-gray-100 px-2 py-1 rounded-full"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              ã™ã¹ã¦ã®ç”»åƒã‚’å‰Šé™¤
            </button>
          )}
          
          {attachments.map((attachment) => (
            <div key={attachment.id} className="relative group">
              {attachment.type === 'image' && (
                <div className="w-20 h-20 rounded-md overflow-hidden border border-gray-300">
                  <Image 
                    src={attachment.url} 
                    alt="æ·»ä»˜ç”»åƒ" 
                    width={80} 
                    height={80} 
                    className="object-cover w-full h-full"
                  />
                </div>
              )}
              
              {attachment.type === 'video' && (
                <div className="w-20 h-20 rounded-md overflow-hidden border border-gray-300 bg-black relative">
                  {/* ã‚µãƒ ãƒã‚¤ãƒ«ãŒã‚ã‚Œã°è¡¨ç¤º */}
                  {attachment.thumbnailUrl ? (
                    <Image 
                      src={attachment.thumbnailUrl} 
                      alt="å‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«" 
                      width={80} 
                      height={80} 
                      className="object-cover w-full h-full"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center">
                      <HiVideoCamera className="text-white w-8 h-8" />
                    </div>
                  )}
                  {/* å‹•ç”»å†ç”Ÿã‚¢ã‚¤ã‚³ãƒ³ */}
                  <div className="absolute inset-0 flex items-center justify-center">
                    <div className="w-8 h-8 bg-white bg-opacity-70 rounded-full flex items-center justify-center">
                      <div className="w-0 h-0 border-t-transparent border-t-8 border-b-transparent border-b-8 border-l-white border-l-12 ml-1"></div>
                    </div>
                  </div>
                  {/* å‹•ç”»ã®é•·ã•è¡¨ç¤º */}
                  {attachment.duration && (
                    <div className="absolute bottom-0 right-0 bg-black bg-opacity-70 text-white text-xs px-1 py-0.5">
                      {Math.floor(attachment.duration / 60)}:{Math.floor(attachment.duration % 60).toString().padStart(2, '0')}
                    </div>
                  )}
                </div>
              )}
              
              {attachment.type === 'location' && (
                <div className="w-20 h-20 rounded-md overflow-hidden border border-gray-300 relative">
                  {/* åœ°å›³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ */}
                  {attachment.previewUrl ? (
                    <Image 
                      src={attachment.previewUrl} 
                      alt="åœ°å›³" 
                      width={80} 
                      height={80} 
                      className="object-cover w-full h-full"
                    />
                  ) : (
                    <div className="w-full h-full bg-gray-100 flex items-center justify-center">
                      <HiLocationMarker className="text-primary-500 w-8 h-8" />
                    </div>
                  )}
                  {/* åœ°å›³ãƒ”ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ */}
                  <div className="absolute top-1 left-1 bg-white rounded-full p-1 shadow-md">
                    <HiLocationMarker className="text-red-500 w-4 h-4" />
                  </div>
                  {/* ä½ç½®æƒ…å ±ãƒ©ãƒ™ãƒ« */}
                  <div className="absolute bottom-0 left-0 right-0 bg-[#06c755] bg-opacity-90 text-white text-xs px-1 py-0.5 truncate text-center">
                    ç¾åœ¨åœ°
                  </div>
                </div>
              )}
              
              <button
                className="absolute top-0 right-0 bg-gray-800 bg-opacity-70 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition"
                onClick={() => removeAttachment(attachment.id)}
              >
                <IoClose className="w-4 h-4" />
              </button>
            </div>
          ))}
        </div>
      )}
      
      <div className="flex items-end">
        <div className="relative mr-2">
          <button
            className="text-gray-500 hover:text-primary-500 p-2 transition-colors"
            onClick={() => setIsAttachmentMenuOpen(!isAttachmentMenuOpen)}
          >
            <HiPaperClip className="w-6 h-6" />
          </button>
          
          {/* æ·»ä»˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
          <AnimatePresence>
            {isAttachmentMenuOpen && (
              <motion.div
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: 10 }}
                className="absolute bottom-12 left-0 bg-white rounded-md shadow-lg p-1 w-48 z-10"
              >
                <input
                  type="file"
                  ref={fileInputRef}
                  accept="image/*"
                  multiple
                  className="hidden"
                  onChange={handleImageAttachment}
                />
                <input
                  type="file"
                  ref={videoInputRef}
                  accept="video/*"
                  className="hidden"
                  onChange={handleVideoAttachment}
                />
                
                <button
                  className={`flex items-center w-full p-2 hover:bg-gray-100 rounded text-left text-sm ${attachments.filter(a => a.type === 'image').length >= 5 ? 'cursor-not-allowed opacity-50' : ''}`}
                  onClick={() => fileInputRef.current?.click()}
                  disabled={attachments.filter(a => a.type === 'image').length >= 5}
                >
                  <HiPhotograph className="w-5 h-5 mr-2 text-green-500" />
                  <span>ç”»åƒ {attachments.filter(a => a.type === 'image').length >= 5 ? '(ä¸Šé™åˆ°é”)' : ''}</span>
                </button>
                
                <button
                  className="flex items-center w-full p-2 hover:bg-gray-100 rounded text-left text-sm"
                  onClick={() => videoInputRef.current?.click()}
                >
                  <HiVideoCamera className="w-5 h-5 mr-2 text-red-500" />
                  <span>å‹•ç”»</span>
                </button>
                
                <button
                  className="flex items-center w-full p-2 hover:bg-gray-100 rounded text-left text-sm"
                  onClick={handleLocationAttachment}
                >
                  <HiLocationMarker className="w-5 h-5 mr-2 text-blue-500" />
                  <span>ä½ç½®æƒ…å ±</span>
                </button>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
        
        <div className="flex-1 bg-gray-100 rounded-2xl flex items-end">
          <textarea
            className="flex-1 bg-transparent border-none resize-none p-3 outline-none text-sm max-h-32"
            placeholder={placeholder}
            value={text}
            onChange={handleTextChange}
            onKeyDown={handleKeyDown}
            rows={1}
            style={{ minHeight: '42px' }}
          />
          
          <button
            className="mx-2 text-gray-500 hover:text-primary-500 p-2 transition-colors"
            onClick={() => setIsEmoticonPickerOpen(!isEmoticonPickerOpen)}
          >
            <HiEmojiHappy className="w-5 h-5" />
          </button>
        </div>
        
        <button
          className={`ml-2 p-2 rounded-full ${
            (!text && attachments.length === 0) || disabled
              ? 'bg-gray-200 text-gray-400'
              : 'bg-[#06c755] text-white hover:bg-[#05b64b]'
          } transition-colors`}
          disabled={(!text && attachments.length === 0) || disabled}
          onClick={handleSendMessage}
          aria-label="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡"
        >
          <RiSendPlaneFill className="w-5 h-5" />
        </button>
      </div>
      
      {/* çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ - å®Ÿè£…ã¯çœç•¥ */}
      {isEmoticonPickerOpen && (
        <div className="absolute bottom-16 right-4 z-10">
          {/* çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã‚’ã“ã“ã«å®Ÿè£… */}
          <div className="bg-white rounded-md shadow-lg p-4">
            <p className="text-sm text-gray-500">çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ (å®Ÿè£…äºˆå®š)</p>
          </div>
        </div>
      )}
    </div>
  );
}
