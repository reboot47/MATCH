# データベース設定と実データテスト手順

このドキュメントでは、Linebuzz 管理者ダッシュボードの実データベース設定とテスト方法について説明します。

## 1. データベース設定

### 環境変数の設定

プロジェクトルートに `.env` ファイルを作成し、以下の内容を追加してください：

```
DATABASE_URL="postgresql://username:password@localhost:5432/linebuzz?schema=public"
```

- `username`: PostgreSQL ユーザー名
- `password`: PostgreSQL パスワード
- ホスト名とポートは必要に応じて変更してください

### PostgreSQL データベースの作成

PostgreSQL がインストールされている状態で、以下のコマンドを実行します：

```bash
# PostgreSQL に接続
psql -U postgres

# データベースを作成
CREATE DATABASE linebuzz;

# データベースに接続
\c linebuzz

# 終了
\q
```

## 2. マイグレーションの実行

環境変数とデータベースを設定した後、以下のコマンドを実行してマイグレーションを適用します：

```bash
# マイグレーションを実行
npx prisma migrate dev --name initial

# Prisma クライアントを生成
npx prisma generate
```

## 3. テストデータの投入

シードスクリプトを実行して、テストデータを登録します：

```bash
# シードスクリプトを実行
npm run prisma:seed
```

## 4. 管理者メッセージ API テスト

テストスクリプトを実行して、管理者メッセージ API が正常に動作することを確認します：

```bash
# テストスクリプトを実行
npx ts-node scripts/test-admin-messages.ts
```

テストスクリプトは以下の項目をテストします：

1. 検索機能
2. フラグ付きメッセージの取得
3. ブロック済みメッセージの取得
4. メッセージのフラグ付け
5. メッセージのブロック

## 5. 管理画面からの確認

開発サーバーを起動してブラウザで管理画面にアクセスし、実データが正しく表示されることを確認します：

```bash
# 開発サーバーを起動
npm run dev
```

ブラウザで http://localhost:3000/admin/messages にアクセスして、メッセージ一覧が表示されることを確認します。

## トラブルシューティング

### マイグレーションエラー

マイグレーション中にエラーが発生した場合は、以下のコマンドでデータベースをリセットしてから再試行してください：

```bash
npx prisma migrate reset
```

### シードデータエラー

シードデータの投入中にエラーが発生した場合は、エラーメッセージを確認し、必要に応じてシードスクリプト（`prisma/seed.ts`）を修正してください。

### 接続エラー

データベース接続に関するエラーが発生した場合は、以下を確認してください：

1. PostgreSQL サービスが実行されているか
2. `.env` ファイルの接続情報が正しいか
3. ファイアウォールなどでポートがブロックされていないか

## 注意事項

- 実際の本番環境では、セキュリティを考慮して適切な認証情報を使用してください
- シードデータにはサンプルユーザーとメッセージが含まれますが、本番環境では実際のデータを使用します
- テストスクリプトは開発環境でのみ使用してください
